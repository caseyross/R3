script.
	import { getContext } from 'svelte'
	import api from '../../../api/index.js'

	import Button from '../../common/Button.pug'
	import CenterLayout from '../../common/layout/CenterLayout.pug'
	import Post from '../post/Post.pug'
	import PostsList from '../posts/PostsList.pug'

	import SubredditInfo from './SubredditInfo.pug'
	import SubredditModerators from './SubredditModerators.pug'
	import SubredditRules from './SubredditRules.pug'
	import SubredditWidget from './SubredditWidget.pug'

	export subreddit_name = null

	export posts_sort = null
	
	export post_short_id = null
	export comment_short_id = null
	export comments_sort = null

	subreddit = null
	set_theme_color = getContext('set_theme_color')
	api.loadWatch(api.ID('subreddit', subreddit_name), (x) ->
		{ data: subreddit } = x
		set_theme_color(subreddit?.primary_color || subreddit?.key_color)
	)
	widgets = null
	api.loadWatch(api.ID('subreddit_widgets', subreddit_name), (x) ->
		{ data: widgets } = x
	)

svelte:head
	title r/{subreddit ? subreddit.display_name : subreddit_name}
CenterLayout
	.subreddit
		nav.subreddit-nav
			{#if subreddit}
				menu.subreddit-options(style='display:none')
					Button(popup={true} text='About')
						SubredditInfo(name={subreddit_name})
					Button(popup={true} text='Rules')
						SubredditRules(name={subreddit_name})
					{#if subreddit.wiki_enabled}
						Button(link='/r/{subreddit_name}/wiki/index' text='Wiki')
		nav.subreddit-posts
			{#key posts_sort}
				PostsList(type='subreddit' subreddit_name={subreddit_name} posts_sort={posts_sort} selected_post_short_id={post_short_id})
		{#if post_short_id}
			{#key post_short_id}
				{#key comment_short_id}
					Post(comments_sort={comments_sort} focus_comment_short_id={comment_short_id} short_id={post_short_id})
		{:else}
			SubredditInfo(name={subreddit_name})
			{#if widgets}
				{#if widgets.topbar?.length}
					SubredditWidget(widget={widgets.topbar[0]})
				ol.subreddit-widgets
					{#each widgets.sidebar as widget}
						SubredditWidget(widget={widget})
			{#if subreddit?.header_title}
				br
				br
				span(style='color:var(--c-text-weak)') "{subreddit.header_title}"

style.
	.subreddit
		width 560px
	.subreddit-nav
		position fixed
		right calc(50% + 336px)
	.subreddit-options
		align-items flex-end
		display flex
		flex-flow column nowrap
		gap 3px
		padding 20px 0
	.subreddit-posts
		height 100dvh
		overflow-y auto
		padding 40px 0
		position fixed
		right calc(50% + 336px)
		scrollbar-width none
		top 0
		&::-webkit-scrollbar
			display none
	.subreddit-widgets
		display flex
		flex-flow column nowrap
		gap 0.5em
script.
	import api from '../../../api/index.js'
	
	import Button from '../../common/Button.pug'
	import Label from '../../common/Label.pug'

	import PostLink from '../post/PostLink.pug'
	import SubredditSidebar from '../subreddit/SubredditSidebar.pug'
	import FeedPostListControls from './FeedPostListControls.pug'

	export collection_short_id = null
	export multireddit_name = null
	export page_size = 10
	export search_query = null
	export sort = null
	export subreddit_name = null
	export time_range = null
	export type = null
	export user_name = null

	base_page_id = switch type
		when 'collection'
			api.ID('collection', collection_short_id)
		when 'multireddit'
			if search_query
				api.ID('search_posts', "multireddit=#{user_name}-#{multireddit_name}+#{search_query}", time_range, sort, page_size)
			else
				api.ID('multireddit_posts', user_name, multireddit_name, time_range, sort, page_size)
		when 'subreddit'
			if search_query
				api.ID('search_posts', "subreddit=#{subreddit_name}+#{search_query}", time_range, sort, page_size)
			else
				api.ID('subreddit_posts', subreddit_name, time_range, sort, page_size)
		when 'user'
			api.ID('user_posts', user_name, time_range, sort, page_size)
	error = null
	has_next_page = false
	loading = null
	short_ids = []

	load_next_page = ->
		after_short_id = short_ids.at(-1)
		page_id = api.ID(base_page_id, after_short_id)
		api.loadWatch(page_id, (x) ->
			{ error, data, loading } = x
			if !error and !loading and data
				short_ids_subset = data?.posts or data
				short_ids = short_ids.concat(short_ids_subset.filter((x) -> !short_ids.includes(x)))
				has_next_page =
					if short_ids_subset.length < page_size
						false
					else
						true
		)

	load_next_page()

svelte:head
	{#if type === 'collection'}
		title collection {collection_short_id}
	{:else if type === 'multireddit'}
		title {multireddit_name}
	{:else if type === 'subreddit'}
		title {subreddit_name}
	{:else if type === 'user'}
		title {user_name}
nav.feed
	{#if type !== 'collection'}
		FeedPostListControls(feed_type={type} multireddit_name={multireddit_name} subreddit_name={subreddit_name} user_name={user_name} search_query={search_query} sort={sort} time_range={time_range})
	{#if type === 'collection' || type === 'multireddit' || type === 'subreddit' || type === 'user'}
		ol.feed-post-list
			{#each short_ids as post_short_id (post_short_id)}
				PostLink(post_short_id={post_short_id} show_subreddit={type !== 'subreddit'})
	menu.feed-post-list-actions
		{#if has_next_page}
			Label(text={error ? 'Error: ' + (error.reason || error.message) : ''})
				Button(action={() => load_next_page()} loading={loading} text={error ? 'Retry' : 'More'})
	{#if type === 'subreddit'}
		{#key subreddit_name}
			SubredditSidebar(name={subreddit_name})

style.
	.feed
		display flex
		flex-flow column nowrap
		gap 1em
		width 560px
	.feed-post-list
		display flex
		flex-flow column nowrap
		gap 1em
		padding 0 80px
script.
	import { Format } from '../../../utils/index.js'
	import api from '../../../api/index.js'
	import Button from '../controls/Button.pug'
	import Markup from '../text/Markup.pug'
	import Score from './Score.pug'
	export out_of_context = false
	export short_id = null
	collapsed = false
	comment = null
	replies_loading = false
	api.watch(api.ID.dataset('comment', short_id), (x) ->
		{ data: comment } = x
		if comment?.more_replies
			api.watch(comment.more_replies_id, ((x) -> { loading: replies_loading } = x), { autoload: false })
	)

{#if comment}
	<!-- 'comment' role is draft status and not recognized yet -->
	<!-- svelte-ignore a11y-unknown-role -->
	article.comment(role='comment')
		section.comment-indent
			Score(upload_vote={(vote) => api.send(api.ID.action('vote_comment', short_id, vote))} value={!comment.score_hidden && comment.score} vote={comment.likes == null ? 0 : comment.likes ? 1 : -1})
			button.comment-line-separator(on:mousedown={() => collapsed = !collapsed})
		{#if collapsed}
			section.comment-body-collapsed [ Comment collapsed. ]
		{:else}
			section.comment-body
				.comment-text(title='{Format.time.sRelative(comment.created_utc)} ago by u/{comment.author}')
					Markup(html={comment.body_html})
				{#if !out_of_context && comment.replies.length > 0}
					{#key comment.replies}
						ol.comment-replies
							{#each comment.replies as reply_short_id}
								svelte:self(short_id={reply_short_id})
							{#if comment.more_replies}
								.comment-more-replies
									Button(action={() => api.load(comment.more_replies_id)} appearance='text' loading={replies_loading} text="+ {comment.num_more_replies} more {comment.num_more_replies === 1 ? 'reply' : 'replies'}...")
							{#if comment.deeper_replies}
								.comment-more-replies
									Button(appearance='text' text='â†’ Continue this thread...')
		{#if out_of_context}
			section.comment-links
				Button(link='/post/{comment.link_id.slice(3)}/comment/{short_id}' text='View in post')

style.
	.comment
		display flex
		gap 1ch
		margin-top 2.25em
		position relative
	.comment-body
	.comment-body-collapsed
		width 480px
	.comment-indent
		display flex
		flex 0 0 20px
		flex-flow column nowrap
		gap 6px
	.comment-links
		opacity 0
		transition all 0.25s
		.comment:hover &
			opacity 1
	.comment-line-separator
		background linear-gradient(to right, transparent 5px, currentColor 6px, transparent 6px)
		flex 1
		opacity 0.25
		width 11px
		&:hover
			opacity 1
	.comment-more-replies
	.comment-replies
		margin-top 2.25em
	:global(.comment-text img)
		border-radius 6px
		display inline
		margin-block-start 1px
		margin-inline-start 1px
		max-height 9em
		width auto
script.
	import { afterUpdate } from 'svelte';
	import { Format } from '../../../utils/index.js'
	import Avatar from '../user/Avatar.pug'
	import AVPlayer from './AVPlayer.pug'
	import Button from '../controls/Button.pug'
	import Comment from './Comment.pug'
	import Flair from './Flair.pug'
	import Minimap from '../controls/Minimap.pug'
	import Score from './Score.pug'
	import SelftextMarkup from './SelftextMarkup.pug'
	import api from '../../../api/index.js'
	export id = null
	export standalone = false
	DOM =
		post: null
	post = null
	api.watch(id,
		(x) ->
			{ data: post } = x
			if post?.user_tranches then for tranch in post.user_tranches then api.load(tranch)
	)
	currentScroll = 0
	lineHeight = 21
	minimapPattern = []
	afterUpdate ->
		contentPattern =
			if node = document.querySelector('.post-content')
				[{
					color: 'rgba(0,0,0,0.5)'
					height: Math.trunc(node.clientHeight / lineHeight),
					start: Math.trunc((node.getBoundingClientRect().top - DOM.post.getBoundingClientRect().top) / lineHeight)
				}]
			else []
		commentsPattern = Array.from(
			document.querySelectorAll('.comment-body'),
			(node) -> ({
					color: 'rgba(0,0,0,0.5)'
					height: Math.trunc(node.clientHeight / lineHeight),
					start: Math.trunc((node.getBoundingClientRect().top - DOM.post.getBoundingClientRect().top) / lineHeight)
			})
		)
		minimapPattern = contentPattern.concat(commentsPattern)

svelte:head
	{#if standalone}
		{#if post}
			title post: {post.title}
		{:else}
			title post: {api.ID.body(id)[0]}
{#if post}
	article.post(bind:this={DOM.post} on:scroll={(e) => currentScroll = e.target.scrollTop})
		header.post-header
			h1 {post.title}
		section.post-content
			{#if post.format === 'self'}
				{#if !post.selftext.length}
					.post-selftext-empty
			{:else if post.format === 'prediction'}
				.post-predictions
					{#each post.tournament_data.predictions as prediction}
						h2.post-prediction-title {prediction.title}
						dl.post-prediction-options
							{#each prediction.options as option}
								li
									dt
										meter(max={prediction.total_stake_amount} min={0} value={option.total_amount})
									dd {option.text}
			{:else if post.format === 'media'}
				{#if post.media.length > 1}
					.post-gallery
						{#each post.media as media, index}
							figure(style='max-width: {media.aspect_ratio * 360}px')
								a(href={media.image_url} rel='external noopener preconnect' target='_blank')
									picture
										source(srcset={media.image_url_640})
										img.post-gallery-image(alt='image {index + 1} of {post.media.length} in gallery' src={media.image_url} style="aspect-ratio: {media.aspect_ratio}")
								{#if media.caption_text || media.caption_url}
									figcaption.post-gallery-image-caption
										{#if media.caption_text}
											p {media.caption_text}
										{#if media.caption_url}
											a(href={media.caption_url}) {media.caption_url}
				{:else}
					{@const media = post.media[0]}
						{#if media.video_url}
							AVPlayer(audio_url={media.video_audio_url} dimensions={[640, 360]} mimic_gif={media.is_gif} video_url={media.video_url})
						{:else if media.image_url}
							a(href={media.image_url} rel='external noopener preconnect' target='_blank')
								picture
									source(srcset={media.aspect_ratio < 1.5 ? media.image_url_640 : media.image_url_960})
									img.post-image(alt='' src={media.image_url} style="aspect-ratio: {media.aspect_ratio}; width: {Math.min(media.source_width, media.aspect_ratio < 1.5 ? 640 : 960)}px")
			{:else if post.format === 'embed'}
				{#each post.media as media}
					{#if media.iframe_url}
						<!-- svelte wants iframe "title" attribute, which interferes with fullscreen playback (tooltip obscuring screen) and anyway provides no additional info here beyond what's in the URL -->
						<!-- svelte-ignore a11y-missing-attribute -->
						iframe.post-iframe(allow={media.iframe_allow} allowfullscreen='true' src={media.iframe_url})
						menu.post-iframe-actions
							Button(action={() => window.open(post.url)} key='o' text='Open original')
					{:else if media.html}
						{@html media.html}
			{:else if post.format === 'link'}
				a(href={post.url} rel='external noopener preconnect') {post.url}
				menu.post-link-actions
					Button(action={() => window.open(post.url)} key='e' text='Open link')
			{:else}
				p [Error displaying post.]
			{#if post.selftext_html}
				.post-selftext
					SelftextMarkup(html={post.selftext_html})
		{#if post.replies?.length}
			{#key post.replies}
				ol.post-replies
					{#each post.replies as replyId}
						Comment(id={replyId})
					{#if post.more_replies}
						.post-more-replies
							Button(action={() => api.load(post.more_replies_id)} appearance='text' text="+ {post.more_replies.length} more {post.more_replies.length === 1 ? 'reply' : 'replies'}...")
		.post-minimap
			Minimap(contentHeight={DOM.post?.scrollHeight} currentScroll={currentScroll} pattern={minimapPattern} scroll={(y) => DOM.post.scrollTop = y} viewingWindowHeight={DOM.post?.offsetHeight})

style.
	.post
		height 100%
		overflow auto
		padding 2em
		&::-webkit-scrollbar
			display none
	.post-content
		margin-top 2em
		position relative
	.post-gallery
		display flex
		flex-flow row wrap
		gap 40px
	.post-gallery-image
		max-height 360px
		max-width 100%
		&:hover
			outline solid
	.post-gallery-image-caption
		font-size 0.75em
		padding-top 0.5em
		text-align center
	.post-header
		max-width 640px
	.post-iframe
		aspect-ratio 16 / 9
		max-width 100%
		width 640px
	.post-iframe-actions
		display flex
		gap 1em
		margin-top 1em
	.post-image
		max-width 100%
		&:hover
			outline solid
	.post-link-actions
		display flex
		gap 1em
		margin-top 1em
	.post-minimap
		position fixed
		right 0
		top 6em
	.post-more-replies
	:global(.post-replies > .comment)
		margin-top 50px !important
	.post-prediction-options > li
		display flex
	.post-selftext
		margin-top 40px
	:global(.post-selftext-media)
		max-width 100%
		padding 1em 0
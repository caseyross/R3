script.
	import { getContext } from 'svelte'

	import api from '../../../api/index.js'
	import { HexColor, Time } from '../../../lib/index.js'
	import { format_url, relativize_url } from '../../routing/url.coffee'
	import AccountData from '../shared/AccountData.coffee'
	import html_embeds from './embeds/html_embeds.coffee'
	import iframe_embeds from './embeds/iframe_embeds.coffee'

	import BanDialog from '../dialog/BanDialog.pug'
	import Button from '../shared/Button.pug'
	import ButtonFrame from '../shared/ButtonFrame.pug'
	import CommentEditor from '../comment/CommentEditor.pug'
	import Error from '../shared/Error.pug'
	import FormattedHTML from '../shared/FormattedHTML.pug'
	import LiveTime from '../shared/LiveTime.pug'
	import MediaPlayer from '../shared/MediaPlayer.pug'
	import Popup from '../shared/Popup.pug'
	import PostComments from './PostComments.pug'
	import PostCommentsAutorefreshButton from './PostCommentsAutorefreshButton.pug'
	import PostFlair from './PostFlair.pug'
	import PostTag from './PostTag.pug'
	import ReportDialog from '../dialog/ReportDialog.pug'
	import SubredditAvatar from '../subreddit/SubredditAvatar.pug'
	import UserByline from '../user/UserByline.pug'
	import Warning from '../shared/Warning.pug'
	
	export comments_initial_count = 25
	export comments_sort = null
	export expanded = true
	export focus_comment_id = null
	export focus_comment_parent_count = null
	export id = null
	export show_subreddit = false

	banning = false
	comments_sort_options = [
		{ label: 'Best', value: 'confidence' }
		{ label: 'Top', value: 'top' }
		{ label: 'Q&A', value: 'qa' }
		{ label: 'Old', value: 'old' }
		{ label: 'New', value: 'new' }
		{ label: 'Controversial', value: 'controversial' }
	]
	comments_sort_options_chat = [
		{ label: 'New (Chat Mode)', value: 'new' }
		{ label: 'Old (Chat Mode)', value: 'old' }
	]
	comments_sort_options_contest = [
		{ label: 'Random (Contest Mode)', value: 'random' }
	]
	error = null
	internal_navigate = getContext('internal_navigate') # would prefer not to need this, but browsers don't support <a> in <select>
	link_domain = (href) ->
		if href.startsWith('/')
			return ''
		url = new URL(href)
		if url.hostname.startsWith('www')
			return url.hostname[4..]
		else
			return url.hostname
	link_path = (href) ->
		if href.startsWith('/')
			return href
		url = new URL(href)
		path = url.pathname
		if url.search
			path = path + '?' + url.search
		if url.hash
			path = path + '#' + url.hash
		return path
	loading = false
	post = null
	replying = false
	reply_error = null
	reply_sending = false
	reporting = false
	score_color = (post) -> switch
		when post.distinguished is 'admin' then 'var(--c-admin)'
		when post.distinguished is 'moderator' then 'var(--c-mod)'
		when post.hide_score or !Number.isFinite(post.score) then 'var(--c-score-0)'
		when Math.log10(post.score) > 3 then 'var(--c-score-4)'
		when Math.log10(post.score) > 2 then 'var(--c-score-3)'
		when Math.log10(post.score) > 1 then 'var(--c-score-2)'
		when Math.log10(post.score) > 0 then 'var(--c-score-1)'
		else 'var(--c-score-0)'
	score_text_color = (post) -> switch
		when post.distinguished is 'admin' then 'white'
		when post.distinguished is 'moderator' then 'white'
		when post.hide_score or !Number.isFinite(post.score) then 'black'
		when Math.log10(post.score) > 3 then 'white'
		when Math.log10(post.score) > 2 then 'white'
		else 'black'
	set_theme_colors = getContext('set_theme_colors')
	time_color = (post) ->
		return 'darkseagreen'
	title_text = (post) ->
		score_text = switch
			when post.hide_score or !Number.isFinite(post.score) then 'score hidden'
			when post.score > 0 then '+' + post.score
			else post.score
		time_text = Time.sToAbsTimeStr(post.created_utc) +
			if post.edited
				' (edited ' + Time.sToAbsTimeStr(post.edited) + ')'
			else
				''
		return "#{score_text}, #{time_text}"
	
	interact = (action_type, data) ->
		switch action_type
			when 'approve'
				api.submit(api.ID('post_approve'), {}, (status) ->
					if status.success
						api.submit(api.ID('post_ignore_reports', id))
				)
			when 'downvote'
				api.submit(api.ID('post_vote', id), { numerical_vote: if post.likes == false then 0 else -1 })
			when 'edit'
				window.open('https://reddit.com/' + id)
			when 'remove'
				api.submit(api.ID('post_remove', id))
			when 'remove_and_ban_user'
				banning = true
			when 'remove_and_ban_user_finish'
				api.submit(api.ID('user_ban', data.user_name, data.subreddit_name), { days: data.days, message_to_user: data.message_to_user, violation_reason: data.violation_reason })
				interact('remove')
				banning = false
			when 'reply'
				replying = true
			when 'reply_finish'
				api.submit(api.ID('post_reply', id, comments_sort or 'confidence', comments_initial_count, focus_comment_id, focus_comment_parent_count), { text: data.text }, (status) ->
					reply_error = status.error
					reply_sending = status.sending
					if status.success
						replying = false
				)
			when 'report'
				reporting = true
			when 'report_finish'
				api.submit(api.ID('post_report', id), { violation_reason: data.violation_reason })
				reporting = false
			when 'save'
				api.submit(api.ID('post_save', id), {})
			when 'unsave'
				api.submit(api.ID('post_save', id), { unsave: true })
			when 'upvote'
				api.submit(api.ID('post_vote', id), { numerical_vote: if post.likes == true then 0 else 1 })

	api.loadWatch(api.ID('post', id), (x) ->
		{ data: post, error, loading } = x
		if post?.suggested_sort && !comments_sort
			comments_sort = post.suggested_sort
		if expanded and post?.subreddit
			api.loadWatch(api.ID('subreddit', post.subreddit), (x) ->
				{ data: subreddit } = x
				set_theme_colors(subreddit?.primary_color, subreddit?.key_color)
			)
	)
	api.preload(api.ID('post', id, comments_sort or 'confidence', comments_initial_count, focus_comment_id, focus_comment_parent_count))
	if expanded
		AccountData.mark_post_read(id)

svelte:head
	{#if expanded && post}
		title {post.subreddit.toLowerCase()} / {post.title}
{#if error}
	{#if error.code === 403}
		Error(message="This post is in a private subreddit which you are not approved to access." title="Private subreddit")
	{:else if error.code === 404}
		Error(message="This subreddit was closed permanently by Reddit admins." title="Subreddit banned")
	{:else if error.reason}
		Error(message="An error occurred. This is the best description we have of the error." title="Error: {error.reason}")
	{:else}
		Error(message="An unknown error occurred." title="Unknown error")
{:else if post}
	article.post(class:post-downvoted={post.likes === false} class:post-expanded={expanded} class:post-spoiler={post.spoiler}class:post-stickied={post.stickied} class:post-upvoted={post.likes === true} class:post-with-low-score={post.score < 1} data-can-edit={post.author === api.getUser() || null} data-can-interact={(api.isLoggedIn() && !post.locked) || null} data-can-mod={post.can_mod_post || null} data-locked={post.locked || null} data-radial-menu='post' data-saved={post.saved || null} on:radialmenu={e => interact(e.detail)} title={title_text(post)})
		header.post-header
			{#if show_subreddit}
				data.post-subreddit
					SubredditAvatar(name={post.subreddit} size='medium')
			{#if post.link_flair_text || post.locked || post.over_18 || post.spoiler || post.stickied}
				ol.post-tags
					{#if post.link_flair_text}
						PostFlair(color={post.link_flair_background_color} emoji_style='image' rich_text={post.link_flair_richtext} subreddit_name={post.subreddit} text={post.link_flair_text})
					{#if post.spoiler}
						PostTag(name='spoiler')
					{#if post.over_18}
						PostTag(name='nsfw')
					{#if post.stickied}
						PostTag(name='sticky')
					{#if post.locked}
						PostTag(name='locked')
			h1.post-title {post.title}
			{#if false}
				.post-date
					LiveTime(create_s={post.created_utc} edit_s={post.edited})
			.post-metrics
				.post-score(style='background: {score_color(post)}; color: {score_text_color(post)}') {Number.isFinite(post.score) ? post.score : '???'}
				.post-time(style='background: {time_color(post)}; color: white') {Time.sToRelTimeStr(post.created_utc, { abbr : true })}
			{#if false}
				figure.post-visual-metrics(title="{post.hide_score ? '???' : post.score} points, {post.num_comments} comments")
					figure.post-visual-metrics-comments(style='height: {8 * Math.log10(1 + post.num_comments)}px')
					figure.post-visual-metrics-score(style='height: {8 * Math.log10(1 + post.score)}px')
				UserByline(distinguish={post.distinguished} flair_rich_text={post.author_flair_richtext} flair_text={post.author_flair_text} name={post.author})
		{#if expanded}
			section.post-content
				{#if post.removed_by_category}
					{#if post.removed_by_category === 'author' || post.removed_by_category === 'deleted'}
						Error(message="Post deleted by author.")
					{:else if post.removed_by_category === 'automod_filtered'}
						Error(message="Post removed by AutoModerator.")
					{:else if post.removed_by_category === 'content_takedown'}
						Error(message="Post removed by Reddit due to site policy violation(s).")
					{:else if post.removed_by_category === 'copyright_takedown'}
						Error(message="Post removed by Reddit due to a copyright notice.")
					{:else if post.removed_by_category === 'moderator'}
						Error(message="Post removed by a moderator.")
					{:else if post.removed_by_category === 'reddit'}
						Error(message="Post removed by Reddit's spam filter.")
					{:else}
						Error(message="Post removed by Reddit (reason not specified).")
				{:else if focus_comment_id}
					Warning(message="Viewing a single comment.")
						Button(link={format_url({ post_id: id, subreddit_name: post.subreddit })} text='View full post')
				{:else if post.format === 'talk'}
					Error(message="Reddit Talks are only available on the official site.")
						Button(key='e' link='https://www.reddit.com/talk/{post.live_audio?.room_id}' new_tab={true} text='View on Reddit')
				{:else}
					{#if post.selftext_html}
						.post-selftext
							FormattedHTML(html={post.selftext_html})
					{:else if post.format === 'self'}
						.post-selftext-none (No post text.)
					{#if post.format === 'crosspost'}
						a.post-crosspost-link(href={format_url({ post_id: post.crosspost_parent })})
							svelte:self(expanded={false} id={post.crosspost_parent})
					{:else if post.format === 'image'}
						ol.post-gallery
							{#each post.media as media, i}
								figure.post-gallery-image
									a(href={media.image_url} rel='external noreferrer preconnect' target='_blank')
										picture
											{#if !media.is_gif}
												source(srcset={media.image_url_960})
												source(srcset={media.image_url_640})
											img.post-image(alt='{i + 1} of {post.media.length}' src={media.image_url} style="aspect-ratio: {media.aspect_ratio}")
									{#if media.caption_text || media.caption_url}
										figcaption.post-gallery-image-caption
											{#if media.caption_text}
												| {media.caption_text}
											{#if media.caption_url}
												a(href={relativize_url(media.caption_url)}) {relativize_url(media.caption_url)}
					{:else if post.format === 'link'}
						{#if post.url}
							{#if html_embeds(post)}
								{@const embed = html_embeds(post)}
									{@html embed.html}
									{#if embed.script === 'twitter'}
										script(defer='true' src='https://platform.twitter.com/widgets.js')
							{:else if iframe_embeds(post.url)}
								{@const embed = iframe_embeds(post.url)}
									<!-- svelte wants iframe "title" attribute, which interferes with fullscreen playback (tooltip obscuring screen) and anyway provides no additional info here beyond what's in the URL -->
									<!-- svelte-ignore a11y-missing-attribute -->
									iframe.post-iframe(allow={embed.iframe_allow} allowfullscreen='true' src={embed.iframe_url})
							{:else}
								a.post-link(href={relativize_url(post.url)} rel='external noopener preconnect')
									span.post-link-domain {link_domain(relativize_url(post.url))}
									span.post-link-path {link_path(relativize_url(post.url))}
					{:else if post.format === 'prediction'}
						ol.md.post-predictions
							{#each post.tournament_data.predictions as prediction}
								strong.post-prediction-title {prediction.title}
								dl.post-prediction-options
									{#each prediction.options as option}
										li.post-prediction-option
											dt
												meter(max={prediction.total_stake_amount} min={0} value={option.total_amount})
											dd {option.text}
						menu.post-content-actions
							Button(key='e' link={post.url} new_tab={true} text='Vote on Reddit')
					{:else if post.format === 'video'}
						{@const media = post.media[0]}
							MediaPlayer(audio_url={media.video_audio_url} height={480} video_url={media.video_url} width={480})
			section.post-comments
				menu.post-comments-sort-controls
					Button(action={value => internal_navigate({ href: location.origin + format_url({ post_comments_sort: value, post_id: id, subreddit_name: post.subreddit }) })} disabled={!post.num_comments} options={post.discussion_type === 'CHAT' ? comments_sort_options_chat : post.contest_mode ? comments_sort_options_contest : comments_sort_options} selected={comments_sort})
					{#if comments_sort === 'new'}
						PostCommentsAutorefreshButton(count={comments_initial_count} post_id={id})
				{#if replying}
					CommentEditor(error={reply_error} on:submit={e => interact('reply_finish', { text: e.detail })} sending={reply_sending})
				{#key comments_sort}
					PostComments(focus_comment_parent_count={focus_comment_parent_count} focus_comment_id={focus_comment_id} initial_count={comments_initial_count} post_id={id} sort={comments_sort})
		{#if banning}
			Popup(on:close={() => banning = false})
				BanDialog(on:submit={e => interact('remove_and_ban_user_finish', { days: e.detail.days, message_to_user: e.detail.message_to_user, subreddit_name: post.subreddit, user_name: post.author })})
		{#if reporting}
			Popup(on:close={() => reporting = false})
				ReportDialog(on:submit={e => interact('report_finish', { violation_reason: e.detail })} subreddit_name={post.subreddit} target_type='post')
{:else if loading}
	article.post.post-loading Loading...

style.
	.post-metrics
		border 2px solid var(--c-bg)
		border-radius 7px
		display grid
		font-feature-settings 'ss01', 'tnum'
		font-size 12px
		font-weight bold
		gap 2px
		grid-template-columns 1fr
		grid-template-rows 20px 20px
		position absolute
		right calc(100% + 32px)
		top 0
	.post-score
		border-radius 5px 5px 0 0
		padding 0 7px
		text-align center
	.post-time
		border-radius 0 0 5px 5px
		padding 0 7px
		text-align center
	.post
		padding 1em 0
		width 480px
		&.post-expanded
			padding 0 80px
			width 640px
		&.post-loading
			padding 10px
	.post-comments
		margin-top 3em
		padding-left calc(50% - 240px)
		width 100%
	.post-content
		align-items flex-start
		display flex
		flex-flow column nowrap
		gap 1.333em
		margin-top 2em
		width 100%
		:global(& .twitter-tweet)
			margin 0 !important
			width 480px !important
		:global(& iframe[id^=twitter-widget])
			border-radius 12px
	.post-content-actions
		align-items center
		display flex
		gap 0.666em
		justify-content space-between
		width 100%
	.post-crosspost-link
		border-radius 1em
		border 1px solid var(--c-text-faint)
		padding 2em
	.post-date
		left calc(100% + 1em)
		position absolute
		top 0
	.post-gallery
		align-items center
		display flex
		flex-flow column nowrap
		gap 1.333em
	.post-gallery-image
		display flex
		flex-flow column nowrap
		gap 6px
	.post-gallery-image-caption
		color var(--c-text-weak)
		font-size 13px
		letter-spacing 0.375pt
	.post-header
		position relative
	.post-iframe
		aspect-ratio 1
		border 1px solid
		border-radius 1em
		margin-inline-start -1px
		width 480px
	.post-image
		border 1px solid
		border-radius 1em
		margin-inline-start -1px
		width 480px
	.post-link
		color var(--c-link)
		display block
		font-size 1.25em
		word-break break-all
		&:hover
			text-decoration underline
	.post-link-domain
		font-weight bold
	.post-link-path
		* ~ &
			margin-left -4px
	.post-predictions
		display flex
		flex-flow column nowrap
		gap 1em
	.post-prediction-option
		align-items center
		display flex
		gap 1em
		& meter
			width 240px
	.post-selftext
		background var(--c-bg-component)
		border-radius 1em
		display inline-block
		padding 10px 1em
	.post-selftext-none
		color var(--c-text-faint)
	.post-subreddit
		aspect-ratio 1
		display inline-block
		height 32px
		position absolute
		right calc(100% + 2em)
		top 0
		.post-expanded &
			left calc(100% + 2em)
			right unset
	.post-tags
		display flex
		flex-flow row wrap
		gap 5px
		margin-bottom 0.5em
	.post-title
		font-size 1.6em
		font-weight var(--f-wght-xstrong)
		letter-spacing calc(-1px/3)
		line-height 1.25
		overflow-wrap anywhere
	.post-visual-metrics
		align-items center
		aspect-ratio 1
		display flex
		justify-content center
		height 48px
		position absolute
		right calc(100% + 2em)
		top 0
	.post-visual-metrics-comments
		aspect-ratio 1
		background var(--c-subreddit-theme-text)
		border-radius 999px
		position absolute
	.post-visual-metrics-score
		aspect-ratio 1
		border 1px solid var(--c-subreddit-theme-text)
		border-radius 999px
		position absolute
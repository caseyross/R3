script.
	import { getContext } from 'svelte'

	import api from '../../../api/index.js'
	import { apply_query_parameters, format_url } from '../../url/index.js'

	import AccountState from '../../state/AccountState.coffee'
	
	import Button from '../common/Button.pug'
	import Comment from '../post/Comment.pug'
	import FeedLink from './FeedLink.pug'
	import FeedSearchOptions from './FeedSearchOptions.pug'
	import FeedSortOptions from './FeedSortOptions.pug'
	import Label from '../common/Label.pug'
	import Message from '../message/Message.pug'
	import Post from '../post/Post.pug'
	import Status from '../common/Status.pug'

	export collection_id = null
	export filter = null
	export multireddit_name = null
	export page_size = 10
	export search_sort = null
	export search_text = null
	export sort = null
	export subreddit_name = null
	export time_range = null
	export title = null
	export type = null
	export user_name = null

	base_page_id = switch type
		when 'account_messages'
			api.ID('account_messages', filter, page_size)
		when 'account_owned_multireddits'
			api.ID('account_multireddits_owned', page_size)
		when 'account_saved_comments'
			api.ID('account_saved_comments', user_name, page_size)
		when 'account_saved_posts'
			api.ID('account_saved_posts', user_name, page_size)
		when 'account_subscribed_subreddits'
			api.ID('account_subreddits_subscribed', page_size)
		when 'collection_posts'
			api.ID('collection', collection_id)
		when 'multireddit_posts'
			switch sort
				when 'search' then api.ID('search_posts', "multireddit=#{user_name}-#{multireddit_name}+#{search_text}", 'all', search_sort, page_size)
				else api.ID('multireddit_posts', user_name, multireddit_name, time_range, sort, page_size)
		when 'popular_subreddits'
			api.ID('global_subreddits_popular', page_size)
		when 'subreddit_comments'
			switch sort
				when 'modqueue' then api.ID('subreddit_modqueue_comments', subreddit_name, page_size)
				else api.ID('subreddit_comments', subreddit_name, page_size)
		when 'subreddit_posts'
			switch sort
				when 'modqueue' then api.ID('subreddit_modqueue_posts', subreddit_name, page_size)
				when 'search' then api.ID('search_posts', "subreddit=#{subreddit_name}+#{search_text}", 'all', search_sort, page_size)
				else api.ID('subreddit_posts', subreddit_name, time_range, sort, page_size)
		when 'subreddit_wikipages'
			api.ID('subreddit_wikipages_all', subreddit_name)
		when 'user_comments'
			api.ID('user_comments', user_name, time_range, sort, page_size)
		when 'user_posts'
			api.ID('user_posts', user_name, time_range, sort, page_size)
	
	error = null
	has_next_page = true
	internal_navigate = getContext('internal_navigate')
	loading = null
	next_after_id = (items) ->
		items.at(-1)?.id or items.at(-1)
	next_after_id_type = (items) ->
		switch items.at(-1)?.was_comment
			when true then 'comment'
			when false then 'message'
			else null
	items = []
	read = []
	page_number = 0

	load_next_page = ->
		if sort == 'search' and !search_text
			items = []
			read = []
			has_next_page = false
			page_number = 1
		else
			api.loadWatch(api.ID(base_page_id, next_after_id(items), next_after_id_type(items)), (x) ->
				{ error, data, loading } = x
				if !error and !loading and data
					page_items = data?.posts or data
					new_items = page_items.filter((x) -> !items.includes(x))
					items = items.concat(new_items)
					read = read.concat(new_items.map((x) -> AccountState.check_post_read(x)))
					has_next_page = switch
						when page_items.length < page_size then false
						when type.endsWith('comments') then true
						when type.endsWith('messages') then true
						when type.endsWith('posts') and type != 'collection_posts' then true
						else false
					page_number = page_number + 1
		)

	load_next_page()

{#if items.length > 0 || sort === 'search'}
	{#if title}
		h1.feed-title {title}
	ol.feed(class="feed-type-{type.split('_').at(-1)}")
		{#if type.endsWith('posts')}
			FeedSortOptions(collection_id={collection_id} filter={filter} multireddit_name={multireddit_name} sort={sort} subreddit_name={subreddit_name} time_range={time_range} type={type} user_name={user_name})
			{#if sort === 'search'}
				FeedSearchOptions(multireddit_name={multireddit_name} search_sort={search_sort} search_text={search_text} subreddit_name={subreddit_name})
		{#if type.endsWith('posts') && filter === 'unread' && read.filter(x => x).length > 0}
			Button(action={() => internal_navigate({ href: apply_query_parameters({ filter: 'all' }) })} text="Show {read.filter(x => x).length} read item{read.filter(x => x).length === 1 ? '' : 's'} ")
		{#each items as item, i (item)}
			{#if filter !== 'unread' || !read[i]}
				<!-- svelte-ignore a11y-no-noninteractive-element-interactions -->
				li.feed-item(on:mousedown={e => { if(e.button === 0) { read[i] = true; read = read } }})
					{#if type.endsWith('comments')}
						Comment(id={item?.id || item} out_of_context={true})
					{:else if type.endsWith('messages')}
						{#if item.was_comment}
							Comment(id={item.id} out_of_context={true})
						{:else}
							Message(message={item})
					{:else if type.endsWith('multireddits')}
						FeedLink(multireddit_name={item.split('-')[1]} size='large' type='multireddit' user_name={item.split('-')[0]})
					{:else if type.endsWith('posts')}
						a.feed-post-link(href={format_url({ collection_id, feed_filter: filter, feed_search_sort: search_sort, feed_search_text: search_text, feed_sort: sort, feed_time_range: time_range === 'all' ? null : time_range, multireddit_name, post_id: item, subreddit_name, user_name })})
							Post(expanded={false} id={item} out_of_context={type !== 'subreddit_posts'})
					{:else if type.endsWith('subreddits')}
						FeedLink(size='large' subreddit_name={item} type='subreddit')
					{:else if type === 'subreddit_wikipages'}
						a(href={format_url({ subreddit_name, wikipage_name: item })}) {item.split('/').join(' / ')}
		{#if has_next_page}
			Label(text={error ? 'Error: ' + (error.reason || error.message) : ''})
				Button(action={() => load_next_page()} loading={loading} text={error ? 'Retry' : 'Load more'})
{:else}
	{#if loading}
		.feed-loading Loading {type.split('_').at(-1)}...
	{:else if error}
		Status(type='error' message="Error loading {type.split('_').at(-1)}.")
	{:else if !type.endsWith('reddits') && !(sort === 'search' && !search_text) && !has_next_page}
		Status(type='warning' message="No {type.split('_').at(-1)}.")

style.
	.feed
		align-items inherit
		display flex
		flex-flow column nowrap
		gap 1.333em
		width 100%
	.feed-item
		max-width 100%
	.feed-items
		display flex
		flex-flow column nowrap
		gap 0.666em
	.feed-loading
		color var(--c-text-weak)
	.feed-read-count
		color var(--c-text-weak)
	.feed-title
		color var(--c-text-weak)
		font-size 1.666em
		letter-spacing -0.333px
script.
	import Destinations from './Destinations.pug'
	import DetachedPost from './DetachedPost.pug'
	import FrontPage from './FrontPage.pug'
	import LoggingIn from './LoggingIn.pug'
	import Multireddit from './Multireddit.pug'
	import Subreddit from './Subreddit.pug'
	import UserProfile from './UserProfile.pug'
	import URLState from '../URLState.coffee'

	urlState = new URLState()
	ratelimitCount = ''
	showDestinations = no

	activateLink = (link) -> switch
		when not link then return
		when link.origin is location.origin then urlState = new URLState(link.href)
		when link.target is '_blank' then open(link.href)
		else location.href = link.href
	addEventListener 'click',
		(e) => if e.buttons is 1 then e.preventDefault()
		{ capture: true }
	addEventListener 'mousedown',
		(e) =>
			if e.buttons is 1 and not (e.altKey or e.ctrlKey or e.metaKey)
				activateLink(e.target.closest('a'))
		{ capture: true }
	addEventListener 'keydown',
		(e) => switch e.key
			when 'Enter'
				if e.target.tagName is 'A'
					e.preventDefault()
					activateLink(e.target)
			when 'Escape'
				showDestinations = !showDestinations
		{ capture: true }
	addEventListener 'popstate',
		(e) => urlState = new URLState()
	setInterval(
		-> ratelimitCount = LS.calls.split(',').length,
		6000
	)


{#if urlState.page === 'logging-in'}
	{#await urlState.finishLogin}
		LoggingIn
	{:then}
		svelte:self
{:else}
	{#if urlState.page === 'front'}
		FrontPage
	{:else if urlState.page === 'channel'}
		{#if urlState.channel.type === 'subreddit'}
			Subreddit(channel={urlState.channel})
		{:else if urlState.channel.type === 'multireddit'}
			Multireddit(channel={urlState.channel})
		{:else if urlState.channel.type === 'user'}
			UserProfile(channel={urlState.channel})
	{:else if urlState.page === 'detached-post'}
		{#await urlState.getPost then post}
			DetachedPost(post={post})
	{#if showDestinations}
		Destinations
	#ratelimit {ratelimitCount}

style.
	#ratelimit
		position fixed
		top 0
		right 0
		color blue
		font bold 16px monospace